name: Deploy to microk8s

on:
  workflow_run:
    workflows: ["Docker Build and Push"]
    types:
      - completed
jobs:
  deploy:
    runs-on: self-hosted
    strategy:
      matrix:
        service: [user, club, vote]
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Install and configure microk8s
      run: |
        microk8s.config > ~/.kube/config

    # - name: Login to Docker Hub
    #   run: |
    #     echo ${{ secrets.DOCKER_PASSWORD }} | docker login --username ${{ secrets.DOCKER_USERNAME }} --password-stdin
    # - name: pull down docker image
    #   run: |
    #     docker -H unix:///var/snap/microk8s/current/docker.sock pull justyntemme/${{ matrix.service }}-svc:${{ github.sha }}
    # - name: import docker image into microk8s
    #   run: |
    #     IMAGE_TAG=$(date +%s)
    #     docker tag localhost:32000/justyntemme/${{ matrix.service }}-svc:${{ github.sha }} localhost:32000justyntemme/${{ matrix.service }}-svc:$IMAGE_TAG
    #     # docker save justyntemme/${{ matrix.service }}-svc:${{ github.sha }} | microk8s docker image import -
        
    - name: Deploy the Helm chart
      run: |
          lxc exec microk8s -- microk8s helm upgrade --install ${{ matrix.service }}-svc ./${{ matrix.service }}/deploy/${{ matrix.service }}-svc --set image.tag=${{ github.sha }}  
          # --set image.repository=docker.io/justyntemme/${{ matrix.service }}-svc:${{ github.sha }}
